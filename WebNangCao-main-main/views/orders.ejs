<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Quáº£n lÃ½ Ä‘Æ¡n hÃ ng</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">

  <% if (!user || user.role !== 'admin') { %>
    <div class="text-center text-red-600 mt-10">
      <h1 class="text-2xl font-bold">Báº¡n khÃ´ng cÃ³ quyá»n truy cáº­p vÃ o trang nÃ y.</h1>
      <a href="/login" class="text-blue-500 underline mt-4 block">ÄÄƒng nháº­p</a>
    </div>
  <% } else { %>

  <!-- Header -->
  <header class="bg-red-600 text-white p-6 shadow-md">
    <div class="container mx-auto flex justify-between items-center">
      <h1 class="text-2xl font-bold">ğŸ›’ Quáº£n lÃ½ Ä‘Æ¡n hÃ ng</h1>
      <a href="/admin" class="bg-white text-red-600 px-4 py-2 rounded hover:bg-gray-100">â† Vá» Dashboard</a>
    </div>
  </header>

  <!-- Main content -->
  <main class="container mx-auto p-6 flex-grow">
    <% if (typeof errorMessage !== 'undefined' && errorMessage) { %>
      <div class="alert alert-danger text-red-600">
        <%= errorMessage %>
      </div>
    <% } else if (orders.length === 0) { %>
      <p class="text-center text-gray-600">KhÃ´ng cÃ³ Ä‘Æ¡n hÃ ng nÃ o.</p>
    <% } else { %>
      <table class="table-auto w-full border-collapse border border-gray-300">
        <thead>
          <tr>
            <th class="border border-gray-300 px-4 py-2">MÃ£ Ä‘Æ¡n hÃ ng</th>
            <th class="border border-gray-300 px-4 py-2">KhÃ¡ch hÃ ng</th>
            <th class="border border-gray-300 px-4 py-2">Tá»•ng tiá»n</th>
            <th class="border border-gray-300 px-4 py-2">Tráº¡ng thÃ¡i</th>
            <th class="border border-gray-300 px-4 py-2">HÃ nh Ä‘á»™ng</th>
          </tr>
        </thead>
        <tbody>
          <% orders.forEach(order => { %>
            <tr id="order-<%= order._id %>">
              <td class="border border-gray-300 px-4 py-2"><%= order._id %></td>
              <td class="border border-gray-300 px-4 py-2">
                <p><strong>TÃªn:</strong> <%= order.customerName %></p>
                <p><strong>Email:</strong> <%= order.customerEmail %></p>
                <p><strong>SÄT:</strong> <%= order.customerPhone %></p>
              </td>
              <td class="border border-gray-300 px-4 py-2"><%= order.total %> VND</td>
              <td class="border border-gray-300 px-4 py-2 status-text"><%= order.status %></td>
              <td class="border border-gray-300 px-4 py-2">
                <form data-order-id="<%= order._id %>" class="update-status-form flex items-center">
                  <select name="status" class="border border-gray-300 rounded px-2 py-1">
                    <option value="Pending" <%= order.status === 'Pending' ? 'selected' : '' %>>Chá» xá»­ lÃ½</option>
                    <option value="Processing" <%= order.status === 'Processing' ? 'selected' : '' %>>Äang xá»­ lÃ½</option>
                    <option value="Completed" <%= order.status === 'Completed' ? 'selected' : '' %>>HoÃ n thÃ nh</option>
                    <option value="Cancelled" <%= order.status === 'Cancelled' ? 'selected' : '' %>>ÄÃ£ há»§y</option>
                  </select>
                  <button type="submit" class="ml-2 bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600">Cáº­p nháº­t</button>
                </form>
              </td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    <% } %>
  </main>

  <% } %>

  <!-- Footer -->
  <footer class="bg-gray-800 text-white py-6 mt-12">
    <div class="container mx-auto text-center text-sm">
      Â© 2025 - Quáº£n lÃ½ Ä‘Æ¡n hÃ ng
    </div>
  </footer>

  <!-- Script cáº­p nháº­t tráº¡ng thÃ¡i báº±ng AJAX -->
  <script>
    document.querySelectorAll('.update-status-form').forEach(form => {
      form.addEventListener('submit', async function (e) {
        e.preventDefault();
        const orderId = this.getAttribute('data-order-id');
        const newStatus = this.querySelector('select[name="status"]').value;

        try {
          const res = await fetch(`/orders/${orderId}/update-status`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ status: newStatus })
          });

          const result = await res.json();
          if (res.ok) {
            const row = document.getElementById(`order-${orderId}`);
            const statusCell = row.querySelector('.status-text');
            statusCell.textContent = newStatus;
            alert('âœ… Tráº¡ng thÃ¡i Ä‘Ã£ Ä‘Æ°á»£c cáº­p nháº­t.');
          } else {
            alert('âŒ Lá»—i: ' + result.message);
          }
        } catch (err) {
          console.error(err);
          alert('âŒ CÃ³ lá»—i xáº£y ra khi cáº­p nháº­t.');
        }
      });
    });
  </script>

</body>
</html>
